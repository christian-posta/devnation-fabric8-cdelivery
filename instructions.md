# Demo scenario

Here is the description/presentation of the steps to be followed in order to setup the environment and run the demo

* Verify that the  `/etc/hosts` file contains a mapping btween the IP address of the VM and these hostnames

```
172.28.128.4	fabric8.local gogs.local vagrant.local docker-registry.vagrant.local fabric8-master.vagrant.local fabric8.vagrant.local gogs.vagrant.local jenkins.vagrant.local kibana.vagrant.local nexus.vagrant.local router.vagrant.local gerrit-ssh.vagrant.local gerrit.vagrant.local gerrit.vagrant.local gerrit-http.vagrant.local sonarqube.vagrant.local letschat.vagrant.local orion.vagrant.local taiga.vagrant.local quickstart-camelservlet.vagrant.local quickstart-rest.vagrant.local
```

* Add the routes used by the macos x machine to access the Pods/Docker containers

```
sudo route -n delete 172.0.0.0/8
sudo route -n add 172.0.0.0/8  172.28.128.4
```

* Install the Openshift Client on your MacosX machine 

# Clone fabric8-installer

Clone the Fabric8-installer project and move to the vagrant/openshift-latest directory. Checkout this id
as the latest commit (19/06/2015) is not working anymore 

```
git clone https://github.com/fabric8io/fabric8-installer
git checkout 09d2005
cd fabric8-installer/vagrant/openshift-latest
```

# Create the Vagrant VM machine

```
vagrant up
```

# Import SSH Keys

In order to use gerrit, we have to import the ssh-keys of the admin and jenkins/gogs/sonar users. The private/public keys of the admin user are mandatory
while optional for the others

* First ssh to the vagrant machine
```
vagrant ssh
```
* Next run these instructions to create directories 
```
sudo mkdir -p /home/gerrit/site
sudo mkdir -p /home/gerrit/admin-ssh-key/
sudo chown -R vagrant /home/gerrit/
mkdir -p /home/gerrit/ssh-keys/
sudo chown -R vagrant /home/gerrit/ssh-keys/
```    
* You can exit from the vagrant machine

# Copy ssh keys

Pass as parameter the location of the vagrant private key

```
cd /Users/chmoulli/MyProjects/MyConferences/devnation-2015/demo/devnation-fabric8-cdelivery
./scripts/copy-keys-vagrant.sh /Users/chmoulli/Fuse/projects/fabric8/fabric8-installer/vagrant/openshift-atest/.vagrant/machines/default/virtualbox/private_key
```

# Compile quickstarts app


* Ope a terminal and change to quickstart fabric8 project
* Check that you use maven 3.2.5 to do the build

```
mvn clean install -Papps -DskipTests=true
```
# Set the env variables required to access Kubernetes & OS

```
./scripts/set_kubenertes_env.sh
```

# Deploy the CDelivery Kube applications on OS

 
```
vn clean install -Pcdelievry
```

* Control that the Fabric8 Pods & Services have been created
```
oc get pods
oc get services

oc get svc
NAME              LABELS                                     SELECTOR                                   IP(S)            PORT(S)
docker-registry   docker-registry=default                    docker-registry=default                    172.30.136.53    5000/TCP
elasticsearch     component=elasticsearch,provider=fabric8   component=elasticsearch,provider=fabric8   172.30.124.123   9200/TCP
fabric8           component=console,provider=fabric8         component=console,provider=fabric8         172.30.235.97    80/TCP
fabric8-forge     component=fabric8Forge,provider=fabric8    component=fabric8Forge,provider=fabric8    172.30.236.9     80/TCP
gogs              component=gogs,provider=fabric8            component=gogs,provider=fabric8            172.30.73.26     80/TCP
gogs-ssh          component=gogs,provider=fabric8            component=gogs,provider=fabric8            172.30.215.233   22/TCP
jenkins           component=jenkins,provider=fabric8         component=jenkins,provider=fabric8         172.30.1.117     80/TCP
kibana            component=kibana,provider=fabric8          component=kibana,provider=fabric8          172.30.25.211    80/TCP
kubernetes        component=apiserver,provider=kubernetes    <none>                                     172.30.0.2       443/TCP
kubernetes-ro     component=apiserver,provider=kubernetes    <none>                                     172.30.0.1       80/TCP
nexus             component=nexus,provider=fabric8           component=nexus,provider=fabric8           172.30.67.68     80/TCP
router            router=router                              router=router                              172.30.165.182   80/TCP

oc get pods
NAME                      READY     REASON    RESTARTS   AGE
docker-registry-1-rr459   1/1       Running   0          44m
elasticsearch-mb3fv       2/2       Running   0          22m
fabric8-0upsk             1/1       Running   0          22m
fabric8-forge-2ma9j       1/1       Running   0          22m
gerrit-ctobk              1/1       Running   0          22m
gogs-148m9                1/1       Running   0          22m
jenkins-29e5i             1/1       Running   0          22m
kibana-zfgyf              1/1       Running   0          22m
nexus-1fsnz               1/1       Running   0          22m
router-1-9us2r            1/1       Running   0          44m
```

* As it seems that the routes are not created by default, we have to recreate them
  So run ths script and check that the routes are created
    
```
./scripts/rebuildroutes.sh

oc get routes
NAME                    HOST/PORT                       PATH      SERVICE           LABELS
docker-registry         docker-registry.vagrant.local             docker-registry   
docker-registry-route   docker-registry.vagrant.local             docker-registry 
  
elasticsearch           elasticsearch.vagrant.local               elasticsearch    
 
fabric8                 fabric8.vagrant.local                     fabric8           
fabric8-forge           fabric8-forge.vagrant.local               fabric8-forge     
gogs                    gogs.vagrant.local                        gogs              
gogs-ssh                gogs-ssh.vagrant.local                    gogs-ssh          
jenkins                 jenkins.vagrant.local                     jenkins           
kibana                  kibana.vagrant.local                      kibana            
nexus                   nexus.vagrant.local                       nexus             
router                  router.vagrant.local                      router 
```    

* We can verify now that nexus, gerrit, gogs & jenkins servers are running.
  So open a web browser with these addresses
  
```
chrome fabric8.vagrant.local 
chrome gogs.vagrant.local 
chrome jenkins.vagrant.local
chrome nexus.vagrant.local
chrome 
```  
    
    
# Delete the Fabric8 App

```
oc delete rc -l provider=fabric8
oc delete pods -l provider=fabric8
oc delete svc -l provider=fabric8
oc delete oauthclients fabric8
oc delete oauthclients gogs

oc get pods -l provider=fabric8
oc get rc -l provider=fabric8
oc get oauthclients | grep fabric8
oc get oauthclients | grep gogs
```

# Delete the containers & images

```
docker rm $(docker ps -a | grep fabric8)
docker rmi $(docker images | grep fabric8)
```
Remark : If location of vagrant changes, update also the IDENTITY env var to get the private_key of vagrant within the script

# Gerrit

```
git clone http://admin@gerrit.vagrant.local/demo2
cd demo2
git review -s
echo "1111" > README.md
git checkout -b mycoolfeature
git add README.md
git commit -m "Commit : 1" -a
git review
```

# Jenkins

Run a DSL Script locally
Before you push a new DSL script to jenkins, it's helpful to run it locally and eyeball the resulting XML. To do this follow these steps:

git clone https://github.com/jenkinsci/job-dsl-plugin.git
cd job-dsl-plugin
./gradlew :job-dsl-core:oneJar
DSL_JAR=$(find job-dsl-core -name '*standalone.jar'|tail -1)
java -jar $DSL_JAR sample.dsl.groovy

java -cp /Users/chmoulli/Fuse/projects/fabric8/default-jenkins-dsl/lib/*:job-dsl-core/build/one-jar-build/lib/*:job-dsl-core/build/one-jar-build/main/main.jar javaposse.jobdsl.Run /Users/chmoulli/Fuse/projects/fabric8/default-jenkins-dsl/seedBuilds.groovy 

# Create gerrit repo 

http --auth-type digest --verbose -a admin:secret PUT http://gerrit.vagrant.local/a/projects/devnation

# Sync Gogs repo with Gerrit
rm -rf devnation/
git clone http://gogs.vagrant.local/root/devnation.git
cd devnation/
git config user.name "Administrator"
git config user.email "admin@fabric8.io"
git config remote.review.url  http://admin@gerrit.vagrant.local/devnation
git config remote.review.push HEAD:refs/for/master
curl -Lo .git/hooks/commit-msg http://gerrit.vagrant.local/tools/hooks/commit-msg
chmod +x .git/hooks/commit-msg
echo "First step to devnation" >> README.md
git add README.md
git commit -m "first commit"
git push review
cd ..

# Get a pull of a review

git pull http://admin@gerrit.vagrant.local/devnation refs/changes/02/2/1

# Delete a gerrit project

http --auth-type digest -a admin:secret DELETE http://gerrit.vagrant.local/a/projects/devnation

# Access a docker container (bash)

docker exec -it $(docker ps | grep 'gerrit:latest' | cut -f1 -d" ") bash

# Regenerate a new json file of gerrit kube app

mvn fabric8:json -Dfabric8.envproperties=something.properties

# Stop a docker container

docker stop $(docker ps | grep 'fabric8/gerrit' | cut -f1 -d" ")

# Setup the env var to access Docker & Kubernetes

unset DOCKER_CERT_PATH
unset DOCKER_TLS_VERIFY
export DOCKER_HOST=tcp://vagrant.local:2375
export KUBERNETES_NAMESPACE=default
export KUBERNETES_MASTER=https://172.28.128.4:8443
export KUBERNETES_DOMAIN=vagrant.local
export KUBERNETES_TRUST_CERT="true"

oc project default
oc login -u admin -p admin https://172.28.128.4:8443  


# Install Base or CDelivery

oc process -v DOMAIN='vagrant.local' -f http://central.maven.org/maven2/io/fabric8/apps/base/2.1.11/base-2.1.11-kubernetes.json | oc create -f -

oc process -v DOMAIN='vagrant.local' -f http://central.maven.org/maven2/io/fabric8/apps/cdelivery-core/2.1.11/cdelivery-core-2.1.11-kubernetes.json | oc create -f -

oc process -v DOMAIN='vagrant.local' -f /Users/chmoulli/Fuse/Fuse-projects/fabric8/quickstarts-forked/app-groups/cdelivery-core/target/classes/kubernetes.json | oc create -f -

oc process -v DOMAIN='vagrant.local' -f /Users/chmoulli/Fuse/Fuse-projects/fabric8/quickstarts-forked/apps/fabric8-forge/target/classes/kubernetes.json | oc create -f -

# Test Fabric8 Maven plugin to create a gerrit repo

mvn io.fabric8:fabric8-maven-plugin:2.3-SNAPSHOT:create-gitrepo -DgerritAdminUsername="admin" -DgerritAdminPassword="secret" -Drepo="demo"
mvnDebug io.fabric8:fabric8-maven-plugin:2.3-SNAPSHOT:create-gitrepo -DgerritAdminUsername="admin" -DgerritAdminPassword="secret" -Drepo="demo"


# Compile & Deploy a project

mvn clean fabric8:json compile 
mvn fabric8:apply -Dfabric8.recreate=true -Dfabric8.domain=vagrant.local


# Gerrit maven plugin to be used to create a gerrit repo

mvn io.fabric8:fabric8-maven-plugin:2.3-SNAPSHOT:create-gitrepo -Drepo="demo" -DgerritAdminUsername="admin" -DgerritAdminPassword="secret" -Dempty_commit="false"

# Git Review

References : 
- http://localhost:8080/Documentation/intro-quick.html
- http://localhost:8080/Documentation/intro-project-owner.html
- http://localhost:8080/Documentation/user-review-ui.html

- http://docs.openstack.org/infra/git-review/usage.html
- https://www.mediawiki.org/wiki/Gerrit/Advanced_usage

# Get Approval infos

git fetch origin refs/notes/review:refs/notes/review
git log --notes=review


